#! /bin/sh 

## This script assume it is being run where it sits, Filter/

date
echo "  "
echo "  "
echo "  Linking mrconso.eng.<model> from mrconso.eng  "
echo "  "
echo "  "

for MODEL in strict moderate relaxed
do
  if [ -s mrconso.eng.$MODEL -a ! -d ../model.$MODEL ]; then 
    echo creating mrconso.eng.$MODEL...hang on...
    mkdir ../model.$MODEL
    case $OS in
	Windows_NT)
	    cp mrconso.eng.$MODEL  ../model.$MODEL/mrconso.filtered
	    ;;
	*)
	    ln -s ../Filter/mrconso.eng.$MODEL  ../model.$MODEL/mrconso.filtered
	    ;;
    esac
  fi
done

date

echo ' '
echo ' '
echo 'Filtering completed.'
echo '    You are now ready to generate the data files.'
echo ' '
echo 'Run another 04Filter* or 05GenerateMWIFiles '
echo ' '
#

# explanation by Francois Lang about what the script does:

# mrconso.eng.strict looks like the following:
# C0000005:L0000005:S0007492|1|P|PF|(131)I-Macroaggregated Albumin|MSH|PEN|D012711
# C0000039:L0012507:S0033298|9|S|PF|Dipalmitoylphosphatidylcholine|LNC|CN|MTHU010538
# C0000039:L0012508:S0033296|10|S|PF|Dipalmitoylglycerophosphocholine|MSH|EN|D015060
# C0000039:L0012509:S0033297|11|S|PF|Dipalmitoyllecithin|MSH|EP|D015060
# C0000039:L6195414:S0033295|13|S|PF|Dipalmitoyl Phosphatidylcholine|MSH|EN|D015060

# cut transforms those lines by deleting all fields after the 5th:
# C0000005:L0000005:S0007492|1|P|PF|(131)I-Macroaggregated Albumin
# C0000039:L0012507:S0033298|9|S|PF|Dipalmitoylphosphatidylcholine
# C0000039:L0012508:S0033296|10|S|PF|Dipalmitoylglycerophosphocholine
# C0000039:L0012509:S0033297|11|S|PF|Dipalmitoyllecithin
# C0000039:L6195414:S0033295|13|S|PF|Dipalmitoyl Phosphatidylcholine

# sort sorts the lines
# cut removes the second field (which was at one point just a line number):
# C0000005:L0000005:S0007492|P|PF|(131)I-Macroaggregated Albumin
# C0000039:L0012507:S0033298|S|PF|Dipalmitoylphosphatidylcholine
# C0000039:L0012508:S0033296|S|PF|Dipalmitoylglycerophosphocholine
# C0000039:L0012509:S0033297|S|PF|Dipalmitoyllecithin
# C0000039:L6195414:S0033295|S|PF|Dipalmitoyl Phosphatidylcholine
#    CUI      LUI      SUI   *  *  String
#                            *  *
#                  Term Status  String Type

# Then the complex call to sed moves the LUI and the SUI to their appropriate spots:
# C0000005|ENG|P|L0000005|PF|S0007492|(131)I-Macroaggregated Albumin|
# C0000039|ENG|S|L0012507|PF|S0033298|Dipalmitoylphosphatidylcholine|
# C0000039|ENG|S|L0012508|PF|S0033296|Dipalmitoylglycerophosphocholine|
# C0000039|ENG|S|L0012509|PF|S0033297|Dipalmitoyllecithin|
# C0000039|ENG|S|L6195414|PF|S0033295|Dipalmitoyl Phosphatidylcholine|

# In the sed call,
#  * \1 is the CUI
#  * \2 is the LUI
#  * \3 is the SUI
#  * \4 is the Term Status (S or P)
#  * \6 is the String Type (one of PF, VO, VCW, VW, VC)

# The sed call used to be much more complicated (and twice as slow),
# but I considerably streamlined it.
# I also put the three models into a for loop to avoid code duplication.
# The output generated by this new version of the script has been validated
# against the previous version of 0doit4 by cmp-ing all the output files.
